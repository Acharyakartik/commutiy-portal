{% extends "html_member/base.html" %}

{% block title %}Donation Voucher{% endblock %}
{% block nav_donation %}active{% endblock %}

{% block page_title %}Donation Voucher{% endblock %}
{% block page_subtitle %}Create donation and download voucher PDF{% endblock %}

{% block content %}
<div class="card card-outline card-warning">
    <div class="card-header d-flex justify-content-between align-items-center">
        <h3 class="card-title mb-0">Donation Entry</h3>
    </div>
    <div class="card-body">
        {% if success_message %}
        <div class="alert alert-success">{{ success_message }}</div>
        {% endif %}

        <form method="post" id="donation-form">
            {% csrf_token %}
            <div class="row">
                <div class="col-md-3">
                    <label for="id_member_no">Member No</label>
                    {{ form.member_no }}
                    {% if form.member_no.errors %}<small class="text-danger">{{ form.member_no.errors|striptags }}</small>{% endif %}
                </div>
                <div class="col-md-2 d-flex align-items-end">
                    <button type="button" id="fetch-member" class="btn btn-info btn-sm">Auto Fetch</button>
                </div>

            <hr>

            <div class="row">
                <div class="col-md-4 mb-2">
                    <label for="id_name">Name</label>
                    {{ form.name }}
                </div>
                <div class="col-md-8 mb-2">
                    <label for="id_address">Address</label>
                    {{ form.address }}
                </div>
                <div class="col-md-4 mb-2">
                    <label for="id_city">City</label>
                    {{ form.city }}
                </div>
                <div class="col-md-4 mb-2">
                    <label for="id_state">State</label>
                    {{ form.state }}
                </div>
                <div class="col-md-4 mb-2">
                    <label for="id_country">Country</label>
                    {{ form.country }}
                </div>
                <div class="col-md-4 mb-2">
                    <label for="id_subject">Subjected To</label>
                    {{ form.subject }}
                </div>
                <div class="col-md-3 mb-2">
                    <label for="id_amount">Amount</label>
                    {{ form.amount }}
                </div>
            </div>

            <div class="mt-3">
                <button type="submit" name="action" value="save" class="btn btn-primary">Save Donation</button>
                <button type="submit" name="action" value="download" class="btn btn-warning">Save & Download PDF</button>
                {% if saved_donation %}
                <a class="btn btn-success" href="{% url 'donation:donation_pdf' saved_donation.id %}">Download Last Saved PDF</a>
                {% endif %}
            </div>
        </form>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
(function () {
    const memberNo = document.getElementById('id_member_no');
    const fetchBtn = document.getElementById('fetch-member');

    function fillMemberData(data) {
        document.getElementById('id_name').value = data.name || '';
        document.getElementById('id_address').value = data.address || '';
        document.getElementById('id_city').value = data.city || '';
        document.getElementById('id_state').value = data.state || '';
        document.getElementById('id_country').value = data.country || '';
        if (data.member_no && !memberNo.value) {
            memberNo.value = data.member_no;
        }
    }

    function fetchMember() {
        const memberNoVal = memberNo.value.trim();
        const url = memberNoVal
            ? "{% url 'donation:member_prefill_api' %}?member_no=" + encodeURIComponent(memberNoVal)
            : "{% url 'donation:member_prefill_api' %}";

        fetch(url, { headers: { 'X-Requested-With': 'XMLHttpRequest' } })
            .then(resp => resp.json())
            .then(data => {
                if (data.status === 'success' && data.member) {
                    fillMemberData(data.member);
                }
            })
            .catch(() => {});
    }

    fetchBtn.addEventListener('click', fetchMember);
    memberNo.addEventListener('blur', fetchMember);

    if (!memberNo.value) {
        fetchMember();
    }
})();
</script>
{% endblock %}
